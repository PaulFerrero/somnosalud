<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåô SomnoSalud - Evaluaci√≥n del Insomnio</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e7;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; }

        .header { text-align: center; padding: 30px 0 20px; }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p { color: #a1a1aa; font-size: 1.1rem; }

        /* STEPPER */
        .stepper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            padding: 0 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .step-circle.pending {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #6b7280;
        }

        .step-circle.active {
            background: linear-gradient(135deg, #818cf8, #6366f1);
            border: 2px solid #818cf8;
            color: white;
            box-shadow: 0 0 20px rgba(129, 140, 248, 0.4);
        }

        .step-circle.completed {
            background: #10b981;
            border: 2px solid #10b981;
            color: white;
        }

        .step-label {
            margin-top: 8px;
            font-size: 0.75rem;
            color: #a1a1aa;
            text-align: center;
            max-width: 80px;
        }

        .step-connector {
            width: 60px;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0 10px;
            margin-bottom: 25px;
        }

        .step-connector.completed {
            background: #10b981;
        }

        /* CARDS */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .card h2 { font-size: 1.3rem; color: #f4f4f5; margin-bottom: 16px; }

        /* INCENTIVE BOX */
        .incentive-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(6, 182, 212, 0.15));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .incentive-box .icon { font-size: 1.5rem; }
        .incentive-box .text { color: #6ee7b7; font-size: 0.95rem; line-height: 1.5; }
        .incentive-box .highlight { color: #fbbf24; font-weight: 600; }

        /* PROGRESS INFO */
        .progress-info {
            background: rgba(129, 140, 248, 0.1);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-text { color: #a5b4fc; font-size: 0.9rem; }
        .progress-percent {
            font-size: 1.5rem;
            font-weight: bold;
            color: #818cf8;
        }

        /* INPUTS */
        .question-group { margin-bottom: 20px; }

        .question-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #d4d4d8;
        }

        .question-group input, .question-group select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #f4f4f5;
            font-size: 1rem;
        }

        .question-group input:focus, .question-group select:focus {
            outline: none;
            border-color: #818cf8;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2);
        }

        /* BUTTONS */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #818cf8, #6366f1);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #d4d4d8;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            margin-top: 10px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-group .btn { flex: 1; }

        /* SEVERITY */
        .severity-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .severity-none { background: #10b981; color: white; }
        .severity-mild { background: #f59e0b; color: white; }
        .severity-moderate { background: #f97316; color: white; }
        .severity-severe { background: #ef4444; color: white; }

        /* RED FLAGS */
        .red-flag {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .red-flag-title { color: #f87171; font-weight: 600; margin-bottom: 8px; }
        .red-flag-action { color: #fca5a5; font-size: 0.9rem; }

        /* RECOMMENDATIONS */
        .recommendation {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .recommendation-title { color: #a5b4fc; font-weight: 600; margin-bottom: 6px; }
        .recommendation-desc { color: #d1d5db; font-size: 0.9rem; }
        .recommendation-evidence {
            display: inline-block;
            background: rgba(129, 140, 248, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #818cf8;
            margin-top: 8px;
        }

        /* CHECKBOX */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: #818cf8;
        }

        /* YES/NO BUTTONS */
        .yes-no-group {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .yes-no-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #d4d4d8;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .yes-no-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .yes-no-btn.selected-yes {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #fca5a5;
        }

        .yes-no-btn.selected-no {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #6ee7b7;
        }

        /* DISCLAIMER */
        .disclaimer {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 16px;
            margin-top: 20px;
            font-size: 0.85rem;
            color: #93c5fd;
        }

        /* GRID */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        /* WELCOME SCREEN */
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .welcome-icon { font-size: 4rem; margin-bottom: 20px; }

        .welcome-title {
            font-size: 1.8rem;
            color: #f4f4f5;
            margin-bottom: 16px;
        }

        .welcome-text {
            color: #a1a1aa;
            font-size: 1.05rem;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .feature-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
            margin-bottom: 30px;
        }

        .feature-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-item .icon { font-size: 1.3rem; }
        .feature-item .text { color: #d4d4d8; font-size: 0.9rem; }

        /* RESULT CARD */
        .result-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(129, 140, 248, 0.3);
        }

        /* SCORE DISPLAY */
        .score-big {
            text-align: center;
            padding: 30px;
            background: rgba(129, 140, 248, 0.1);
            border-radius: 12px;
            margin: 20px 0;
        }

        .score-big .number {
            font-size: 4rem;
            font-weight: bold;
            color: #818cf8;
        }

        .score-big .label {
            color: #a1a1aa;
            margin-top: 8px;
        }

        .score-big .interpretation {
            font-weight: 600;
            margin-top: 12px;
            font-size: 1.1rem;
        }

        /* AUTO-CALC INFO */
        .auto-calc-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 16px;
            margin-top: 20px;
        }

        .auto-calc-title {
            color: #a1a1aa;
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .auto-calc-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .auto-calc-item:last-child { border-bottom: none; }

        /* QUESTION NUMBER */
        .question-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: rgba(129, 140, 248, 0.2);
            border-radius: 50%;
            color: #818cf8;
            font-weight: 600;
            font-size: 0.85rem;
            margin-right: 10px;
        }

        @media (max-width: 600px) {
            .header h1 { font-size: 1.8rem; }
            .container { padding: 12px; }
            .stepper { flex-wrap: wrap; gap: 10px; }
            .step-connector { display: none; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // ============================================
        // TRATAMIENTOS
        // ============================================
        const TRATAMIENTOS = {
            conductuales: [
                { id: 'COND-001', nombre: 'Higiene del Sue√±o', descripcion: 'Mantener horarios regulares, evitar pantallas antes de dormir, ambiente oscuro y fresco.', evidencia: 'A', primera_linea: true },
                { id: 'COND-002', nombre: 'TCC-I (Terapia Cognitivo-Conductual)', descripcion: 'Tratamiento de primera l√≠nea con mejor evidencia a largo plazo. Incluye restricci√≥n de sue√±o, control de est√≠mulos y reestructuraci√≥n cognitiva.', evidencia: 'A', primera_linea: true },
                { id: 'COND-003', nombre: 'T√©cnicas de Relajaci√≥n', descripcion: 'Respiraci√≥n diafragm√°tica, relajaci√≥n muscular progresiva, mindfulness.', evidencia: 'B', primera_linea: true }
            ],
            suplementos: [
                { id: 'SUP-001', nombre: 'Melatonina', descripcion: '0.5-3 mg, 30-60 min antes de acostarse. √ötil especialmente para problemas de inicio del sue√±o.', evidencia: 'B', contraindicaciones: ['Anticoagulantes', 'Embarazo'] },
                { id: 'SUP-002', nombre: 'Magnesio', descripcion: '200-400 mg de glicinato o citrato antes de dormir.', evidencia: 'B', contraindicaciones: ['Insuficiencia renal severa'] },
                { id: 'SUP-003', nombre: 'L-Teanina', descripcion: '100-200 mg antes de dormir. Promueve relajaci√≥n sin sedaci√≥n.', evidencia: 'B', contraindicaciones: [] }
            ]
        };

        // ============================================
        // EVALUACI√ìN
        // ============================================
        function evaluarInsomnio(datos) {
            const resultado = { severidad: '', descripcion: '', isi_score: datos.isi, stop_bang_score: datos.stop_bang, banderas_rojas: [], recomendaciones: [], fenotipo: null, precision: 0 };

            // Calcular precisi√≥n del diagn√≥stico basado en datos completados
            let precisionBase = 60; // Base con solo ISI
            if (datos.stop_bang !== null) precisionBase += 15;
            if (datos.latencia_sueno > 0) precisionBase += 8;
            if (datos.despertares > 0) precisionBase += 7;
            if (datos.sexo) precisionBase += 5;
            resultado.precision = Math.min(precisionBase, 95);

            // Severidad ISI
            if (datos.isi <= 7) { resultado.severidad = 'sin_insomnio'; resultado.descripcion = 'Sin insomnio cl√≠nico significativo'; }
            else if (datos.isi <= 14) { resultado.severidad = 'leve'; resultado.descripcion = 'Insomnio subcl√≠nico o leve'; }
            else if (datos.isi <= 21) { resultado.severidad = 'moderado'; resultado.descripcion = 'Insomnio cl√≠nico moderado'; }
            else { resultado.severidad = 'severo'; resultado.descripcion = 'Insomnio cl√≠nico severo'; }

            // Banderas rojas
            if (datos.ideacion_suicida) resultado.banderas_rojas.push({ titulo: '‚ö†Ô∏è URGENTE: Ideaci√≥n suicida', accion: 'Derivaci√≥n INMEDIATA a salud mental.' });
            if (datos.stop_bang >= 5) resultado.banderas_rojas.push({ titulo: 'Alto riesgo de Apnea (STOP-BANG ‚â•5)', accion: 'Derivar a polisomnograf√≠a ANTES de tratar insomnio.' });
            else if (datos.stop_bang >= 3) resultado.banderas_rojas.push({ titulo: 'Riesgo intermedio de Apnea (STOP-BANG 3-4)', accion: 'Considerar evaluaci√≥n con polisomnograf√≠a.' });
            if (datos.edad >= 65) resultado.banderas_rojas.push({ titulo: 'Paciente ‚â•65 a√±os', accion: 'Precauci√≥n con sedantes. Priorizar TCC-I.' });
            if (datos.embarazo) resultado.banderas_rojas.push({ titulo: 'Embarazo/lactancia', accion: 'Solo medidas no farmacol√≥gicas.' });

            // Fenotipo
            if (datos.latencia_sueno > 30 && datos.despertares <= 1) resultado.fenotipo = { tipo: 'ONSET', nombre: 'Insomnio de inicio' };
            else if (datos.latencia_sueno <= 30 && datos.despertares > 2) resultado.fenotipo = { tipo: 'MANTENIMIENTO', nombre: 'Insomnio de mantenimiento' };
            else if (datos.latencia_sueno > 30 && datos.despertares > 2) resultado.fenotipo = { tipo: 'MIXTO', nombre: 'Insomnio mixto' };

            // Recomendaciones
            resultado.recomendaciones.push(TRATAMIENTOS.conductuales[0]);
            if (resultado.severidad !== 'sin_insomnio') {
                resultado.recomendaciones.push(TRATAMIENTOS.conductuales[1]);
                resultado.recomendaciones.push(TRATAMIENTOS.conductuales[2]);
            }
            if ((resultado.severidad === 'moderado' || resultado.severidad === 'severo') && !datos.embarazo) {
                if (!datos.anticoagulantes) resultado.recomendaciones.push(TRATAMIENTOS.suplementos[0]);
                resultado.recomendaciones.push(TRATAMIENTOS.suplementos[1]);
                resultado.recomendaciones.push(TRATAMIENTOS.suplementos[2]);
            }
            if (resultado.severidad === 'severo' && datos.edad < 65 && !datos.embarazo) {
                resultado.recomendaciones.push({ id: 'FARM', nombre: 'Evaluaci√≥n farmacol√≥gica', descripcion: '‚ö†Ô∏è Considerar hipn√≥ticos solo si TCC-I insuficiente. Uso corto (<4 sem).', evidencia: 'A' });
            }

            return resultado;
        }

        // ============================================
        // APP PRINCIPAL
        // ============================================
        function App() {
            const [step, setStep] = useState(0); // 0=welcome, 1=datos, 2=ISI, 3=STOPBANG, 4=condiciones, 5=resultado
            const [formData, setFormData] = useState({
                edad: '', sexo: '', isi: null, stop_bang: null,
                latencia_sueno: '', despertares: '',
                ideacion_suicida: false, embarazo: false, anticoagulantes: false
            });
            const [resultado, setResultado] = useState(null);

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };

            const handleEvaluar = () => {
                const datos = {
                    ...formData,
                    edad: parseInt(formData.edad) || 0,
                    isi: formData.isi || 0,
                    stop_bang: formData.stop_bang,
                    latencia_sueno: parseInt(formData.latencia_sueno) || 0,
                    despertares: parseInt(formData.despertares) || 0
                };
                setResultado(evaluarInsomnio(datos));
                setStep(5);
            };

            const steps = [
                { label: 'Inicio', icon: 'üëã' },
                { label: 'Datos', icon: 'üìã' },
                { label: 'ISI', icon: 'üìù' },
                { label: 'Apnea', icon: 'üò¥' },
                { label: 'Alertas', icon: 'üö®' },
                { label: 'Resultado', icon: 'üìä' }
            ];

            const getStepStatus = (i) => {
                if (i < step) return 'completed';
                if (i === step) return 'active';
                return 'pending';
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>üåô SomnoSalud</h1>
                        <p>Evaluaci√≥n Personalizada del Insomnio</p>
                    </div>

                    {/* STEPPER */}
                    {step > 0 && step < 5 && (
                        <div className="stepper">
                            {steps.slice(1, 5).map((s, i) => (
                                <React.Fragment key={i}>
                                    <div className="step">
                                        <div className={`step-circle ${getStepStatus(i + 1)}`}>
                                            {getStepStatus(i + 1) === 'completed' ? '‚úì' : s.icon}
                                        </div>
                                        <div className="step-label">{s.label}</div>
                                    </div>
                                    {i < 3 && <div className={`step-connector ${i + 1 < step ? 'completed' : ''}`} />}
                                </React.Fragment>
                            ))}
                        </div>
                    )}

                    {/* PASO 0: BIENVENIDA */}
                    {step === 0 && (
                        <div className="card">
                            <div className="welcome-screen">
                                <div className="welcome-icon">üåô</div>
                                <div className="welcome-title">Bienvenido/a a tu evaluaci√≥n del sue√±o</div>
                                <div className="welcome-text">
                                    En los pr√≥ximos minutos, te guiaremos a trav√©s de una evaluaci√≥n completa
                                    para entender mejor tus problemas de sue√±o y ofrecerte recomendaciones personalizadas
                                    basadas en evidencia cient√≠fica.
                                </div>

                                <div className="feature-list">
                                    <div className="feature-item">
                                        <span className="icon">‚è±Ô∏è</span>
                                        <span className="text">5-7 minutos</span>
                                    </div>
                                    <div className="feature-item">
                                        <span className="icon">üî¨</span>
                                        <span className="text">Basado en ciencia</span>
                                    </div>
                                    <div className="feature-item">
                                        <span className="icon">üéØ</span>
                                        <span className="text">100% personalizado</span>
                                    </div>
                                </div>

                                <button className="btn btn-primary" onClick={() => setStep(1)}>
                                    Comenzar Evaluaci√≥n ‚Üí
                                </button>
                            </div>
                        </div>
                    )}

                    {/* PASO 1: DATOS B√ÅSICOS */}
                    {step === 1 && (
                        <>
                            <div className="incentive-box">
                                <span className="icon">üí°</span>
                                <div className="text">
                                    <strong>¬øPor qu√© estos datos?</strong><br/>
                                    Tu edad y caracter√≠sticas nos permiten <span className="highlight">ajustar las recomendaciones
                                    hasta un 30% m√°s precisas</span> y detectar si necesit√°s precauciones especiales.
                                </div>
                            </div>

                            <div className="card">
                                <h2>üìã Paso 1: Tus datos b√°sicos</h2>

                                <div className="grid-2">
                                    <div className="question-group">
                                        <label>¬øCu√°ntos a√±os ten√©s?</label>
                                        <input type="number" name="edad" value={formData.edad} onChange={handleChange} placeholder="Ej: 45" min="18" max="100" />
                                    </div>
                                    <div className="question-group">
                                        <label>Sexo biol√≥gico</label>
                                        <select name="sexo" value={formData.sexo} onChange={handleChange}>
                                            <option value="">Seleccionar...</option>
                                            <option value="M">Masculino</option>
                                            <option value="F">Femenino</option>
                                        </select>
                                    </div>
                                </div>

                                <div className="grid-2">
                                    <div className="question-group">
                                        <label>¬øCu√°nto tard√°s en dormirte? (minutos)</label>
                                        <input type="number" name="latencia_sueno" value={formData.latencia_sueno} onChange={handleChange} placeholder="Ej: 30" min="0" />
                                    </div>
                                    <div className="question-group">
                                        <label>¬øCu√°ntas veces te despert√°s por noche?</label>
                                        <input type="number" name="despertares" value={formData.despertares} onChange={handleChange} placeholder="Ej: 2" min="0" />
                                    </div>
                                </div>

                                <button className="btn btn-primary" onClick={() => setStep(2)} disabled={!formData.edad}>
                                    {formData.edad ? 'Continuar al cuestionario de insomnio ‚Üí' : 'Ingres√° tu edad para continuar'}
                                </button>
                            </div>
                        </>
                    )}

                    {/* PASO 2: ISI */}
                    {step === 2 && (
                        <ISIQuestionnaire
                            onComplete={(score) => { setFormData(prev => ({...prev, isi: score})); setStep(3); }}
                            onBack={() => setStep(1)}
                        />
                    )}

                    {/* PASO 3: STOP-BANG */}
                    {step === 3 && (
                        <STOPBANGQuestionnaire
                            onComplete={(score) => { setFormData(prev => ({...prev, stop_bang: score})); setStep(4); }}
                            onSkip={() => setStep(4)}
                            onBack={() => setStep(2)}
                            edad={parseInt(formData.edad) || 0}
                            sexo={formData.sexo}
                        />
                    )}

                    {/* PASO 4: CONDICIONES ESPECIALES */}
                    {step === 4 && (
                        <>
                            <div className="incentive-box">
                                <span className="icon">üõ°Ô∏è</span>
                                <div className="text">
                                    <strong>Tu seguridad es lo primero</strong><br/>
                                    Estas preguntas nos ayudan a <span className="highlight">evitar recomendaciones que podr√≠an ser
                                    perjudiciales</span> en tu situaci√≥n particular.
                                </div>
                            </div>

                            <div className="card">
                                <h2>üö® Paso 4: Condiciones importantes</h2>
                                <p style={{color: '#a1a1aa', marginBottom: '20px'}}>
                                    Marc√° las opciones que apliquen a tu situaci√≥n actual:
                                </p>

                                <div className="checkbox-group">
                                    <input type="checkbox" name="ideacion_suicida" checked={formData.ideacion_suicida} onChange={handleChange} />
                                    <label>Tengo pensamientos de hacerme da√±o o ideas suicidas</label>
                                </div>

                                <div className="checkbox-group">
                                    <input type="checkbox" name="embarazo" checked={formData.embarazo} onChange={handleChange} />
                                    <label>Estoy embarazada o en per√≠odo de lactancia</label>
                                </div>

                                <div className="checkbox-group">
                                    <input type="checkbox" name="anticoagulantes" checked={formData.anticoagulantes} onChange={handleChange} />
                                    <label>Tomo anticoagulantes (aspirina, warfarina, etc.)</label>
                                </div>

                                <div className="btn-group">
                                    <button className="btn btn-secondary" onClick={() => setStep(3)}>‚Üê Volver</button>
                                    <button className="btn btn-primary" onClick={handleEvaluar}>
                                        Ver mis resultados ‚Üí
                                    </button>
                                </div>
                            </div>
                        </>
                    )}

                    {/* PASO 5: RESULTADOS */}
                    {step === 5 && resultado && <ResultadoScreen resultado={resultado} formData={formData} onReset={() => { setStep(0); setResultado(null); setFormData({ edad: '', sexo: '', isi: null, stop_bang: null, latencia_sueno: '', despertares: '', ideacion_suicida: false, embarazo: false, anticoagulantes: false }); }} />}
                </div>
            );
        }

        // ============================================
        // CUESTIONARIO ISI
        // ============================================
        function ISIQuestionnaire({ onComplete, onBack }) {
            const [respuestas, setRespuestas] = useState({});

            const preguntas = [
                { texto: "Dificultad para quedarte dormido/a", tipo: "problema" },
                { texto: "Dificultad para mantenerte dormido/a", tipo: "problema" },
                { texto: "Problemas por despertarte muy temprano", tipo: "problema" },
                { texto: "¬øQu√© tan satisfecho/a o insatisfecho/a est√°s con tu patr√≥n de sue√±o actual?", tipo: "satisfaccion" },
                { texto: "¬øCu√°nto interfiere tu problema de sue√±o en tu d√≠a a d√≠a?", tipo: "problema" },
                { texto: "¬øQu√© tan notorio es tu problema de sue√±o para otros?", tipo: "problema" },
                { texto: "¬øQu√© tan preocupado/a est√°s por tu problema de sue√±o?", tipo: "problema" }
            ];

            const opcionesProblema = [
                { valor: 0, texto: "Nada" },
                { valor: 1, texto: "Un poco" },
                { valor: 2, texto: "Algo" },
                { valor: 3, texto: "Mucho" },
                { valor: 4, texto: "Much√≠simo" }
            ];

            const opcionesSatisfaccion = [
                { valor: 0, texto: "Muy satisfecho/a" },
                { valor: 1, texto: "Satisfecho/a" },
                { valor: 2, texto: "Ni satisfecho/a ni insatisfecho/a" },
                { valor: 3, texto: "Insatisfecho/a" },
                { valor: 4, texto: "Muy insatisfecho/a" }
            ];

            const puntaje = Object.values(respuestas).reduce((a, b) => a + b, 0);
            const respondidas = Object.keys(respuestas).length;
            const completo = respondidas === 7;

            const getInterpretacion = (s) => {
                if (s <= 7) return { texto: "Sin insomnio cl√≠nico", color: "#10b981" };
                if (s <= 14) return { texto: "Insomnio leve", color: "#f59e0b" };
                if (s <= 21) return { texto: "Insomnio moderado", color: "#f97316" };
                return { texto: "Insomnio severo", color: "#ef4444" };
            };

            return (
                <>
                    <div className="incentive-box">
                        <span className="icon">üéØ</span>
                        <div className="text">
                            <strong>Cuestionario ISI - El est√°ndar de oro</strong><br/>
                            Este cuestionario validado cient√≠ficamente <span className="highlight">aumenta la precisi√≥n
                            del diagn√≥stico en un 40%</span> y es usado en hospitales de todo el mundo.
                        </div>
                    </div>

                    <div className="progress-info">
                        <span className="progress-text">Preguntas completadas: {respondidas} de 7</span>
                        <span className="progress-percent">{Math.round((respondidas / 7) * 100)}%</span>
                    </div>

                    <div className="card">
                        <h2>üìù Paso 2: √çndice de Severidad del Insomnio</h2>
                        <p style={{color: '#a1a1aa', marginBottom: '24px'}}>
                            Pens√° en las <strong>√∫ltimas 2 semanas</strong> al responder:
                        </p>

                        {preguntas.map((p, i) => {
                            const opciones = p.tipo === 'satisfaccion' ? opcionesSatisfaccion : opcionesProblema;
                            return (
                                <div key={i} className="question-group">
                                    <label><span className="question-number">{i + 1}</span>{p.texto}</label>
                                    <select value={respuestas[i] ?? ''} onChange={(e) => setRespuestas(prev => ({...prev, [i]: parseInt(e.target.value)}))}>
                                        <option value="">-- Seleccion√° una opci√≥n --</option>
                                        {opciones.map(o => <option key={o.valor} value={o.valor}>{o.valor} - {o.texto}</option>)}
                                    </select>
                                </div>
                            );
                        })}

                        {completo && (
                            <div className="score-big">
                                <div className="number">{puntaje}</div>
                                <div className="label">Puntaje ISI (de 28)</div>
                                <div className="interpretation" style={{color: getInterpretacion(puntaje).color}}>
                                    {getInterpretacion(puntaje).texto}
                                </div>
                            </div>
                        )}

                        <div className="btn-group">
                            <button className="btn btn-secondary" onClick={onBack}>‚Üê Volver</button>
                            <button className="btn btn-primary" onClick={() => onComplete(puntaje)} disabled={!completo}>
                                {completo ? `Continuar con puntaje ${puntaje} ‚Üí` : `Complet√° las ${7 - respondidas} preguntas restantes`}
                            </button>
                        </div>
                    </div>
                </>
            );
        }

        // ============================================
        // CUESTIONARIO STOP-BANG
        // ============================================
        function STOPBANGQuestionnaire({ onComplete, onSkip, onBack, edad, sexo }) {
            const [respuestas, setRespuestas] = useState({ S: null, T: null, O: null, P: null, B: null, N: null });

            const preguntas = [
                { id: 'S', titulo: 'Ronquidos', pregunta: '¬øRonc√°s fuerte? (que se escuche a trav√©s de puertas o tu pareja te codee)' },
                { id: 'T', titulo: 'Cansancio', pregunta: '¬øTe sent√≠s frecuentemente cansado/a o somnoliento/a durante el d√≠a?' },
                { id: 'O', titulo: 'Observado', pregunta: '¬øAlguien observ√≥ que dej√°s de respirar mientras dorm√≠s?' },
                { id: 'P', titulo: 'Presi√≥n', pregunta: '¬øTen√©s presi√≥n arterial alta o tom√°s medicaci√≥n para eso?' },
                { id: 'B', titulo: 'IMC >35', pregunta: '¬øTu √≠ndice de masa corporal es mayor a 35?' },
                { id: 'N', titulo: 'Cuello >40cm', pregunta: '¬øLa circunferencia de tu cuello es mayor a 40 cm?' }
            ];

            const edadMayor50 = edad > 50;
            const esMasculino = sexo === 'M';
            const respondidas = Object.values(respuestas).filter(v => v !== null).length;
            const completo = respondidas === 6;

            const puntaje = Object.values(respuestas).filter(v => v === true).length + (edadMayor50 ? 1 : 0) + (esMasculino ? 1 : 0);

            const getInterpretacion = (s) => {
                if (s <= 2) return { texto: "Bajo riesgo de apnea", color: "#10b981" };
                if (s <= 4) return { texto: "Riesgo intermedio", color: "#f59e0b" };
                return { texto: "Alto riesgo - requiere evaluaci√≥n", color: "#ef4444" };
            };

            return (
                <>
                    <div className="incentive-box">
                        <span className="icon">üò¥</span>
                        <div className="text">
                            <strong>¬øPor qu√© evaluar apnea?</strong><br/>
                            La apnea del sue√±o puede causar o empeorar el insomnio. Detectarla <span className="highlight">mejora
                            la efectividad del tratamiento en un 50%</span> y previene complicaciones card√≠acas.
                        </div>
                    </div>

                    <div className="progress-info">
                        <span className="progress-text">Preguntas: {respondidas} de 6 (+ 2 autom√°ticas)</span>
                        <span className="progress-percent">{Math.round((respondidas / 6) * 100)}%</span>
                    </div>

                    <div className="card">
                        <h2>üò¥ Paso 3: Evaluaci√≥n de Apnea (STOP-BANG)</h2>

                        {preguntas.map(p => (
                            <div key={p.id} className="question-group">
                                <label><span className="question-number">{p.id}</span>{p.titulo}</label>
                                <div style={{color: '#d4d4d8', marginBottom: '10px', fontSize: '0.95rem'}}>{p.pregunta}</div>
                                <div className="yes-no-group">
                                    <button type="button" className={`yes-no-btn ${respuestas[p.id] === true ? 'selected-yes' : ''}`} onClick={() => setRespuestas(prev => ({...prev, [p.id]: true}))}>S√≠</button>
                                    <button type="button" className={`yes-no-btn ${respuestas[p.id] === false ? 'selected-no' : ''}`} onClick={() => setRespuestas(prev => ({...prev, [p.id]: false}))}>No</button>
                                </div>
                            </div>
                        ))}

                        <div className="auto-calc-box">
                            <div className="auto-calc-title">üìä Calculado autom√°ticamente de tus datos:</div>
                            <div className="auto-calc-item">
                                <span><strong>A</strong> - Edad mayor a 50</span>
                                <span style={{color: edadMayor50 ? '#f87171' : '#6ee7b7'}}>{edadMayor50 ? 'S√≠ (+1)' : 'No'}</span>
                            </div>
                            <div className="auto-calc-item">
                                <span><strong>G</strong> - Sexo masculino</span>
                                <span style={{color: esMasculino ? '#f87171' : '#6ee7b7'}}>{esMasculino ? 'S√≠ (+1)' : 'No'}</span>
                            </div>
                        </div>

                        {completo && (
                            <div className="score-big">
                                <div className="number">{puntaje}</div>
                                <div className="label">Puntaje STOP-BANG (de 8)</div>
                                <div className="interpretation" style={{color: getInterpretacion(puntaje).color}}>
                                    {getInterpretacion(puntaje).texto}
                                </div>
                            </div>
                        )}

                        <div className="btn-group">
                            <button className="btn btn-secondary" onClick={onBack}>‚Üê Volver</button>
                            <button className="btn btn-primary" onClick={() => onComplete(puntaje)} disabled={!completo}>
                                {completo ? 'Continuar ‚Üí' : `Respond√© las ${6 - respondidas} restantes`}
                            </button>
                        </div>

                        <button className="btn btn-secondary" style={{marginTop: '10px', opacity: 0.7}} onClick={onSkip}>
                            Omitir este paso (menos precisi√≥n)
                        </button>
                    </div>
                </>
            );
        }

        // ============================================
        // PANTALLA DE RESULTADOS
        // ============================================
        function ResultadoScreen({ resultado, formData, onReset }) {
            const getSeverityClass = (s) => {
                if (s === 'sin_insomnio') return 'severity-none';
                if (s === 'leve') return 'severity-mild';
                if (s === 'moderado') return 'severity-moderate';
                return 'severity-severe';
            };

            const getSeverityText = (s) => {
                if (s === 'sin_insomnio') return 'Sin Insomnio Cl√≠nico';
                if (s === 'leve') return 'Insomnio Leve';
                if (s === 'moderado') return 'Insomnio Moderado';
                return 'Insomnio Severo';
            };

            return (
                <>
                    <div className="card result-card">
                        <h2>üìä Tu Resultado Personalizado</h2>

                        <div style={{display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '20px', flexWrap: 'wrap'}}>
                            <div className={`severity-badge ${getSeverityClass(resultado.severidad)}`}>
                                {getSeverityText(resultado.severidad)}
                            </div>
                            <div style={{color: '#a1a1aa'}}>
                                Precisi√≥n del an√°lisis: <strong style={{color: '#818cf8'}}>{resultado.precision}%</strong>
                            </div>
                        </div>

                        <p style={{color: '#d1d5db', marginBottom: '16px', fontSize: '1.05rem'}}>
                            {resultado.descripcion}
                        </p>

                        <div style={{display: 'flex', gap: '24px', flexWrap: 'wrap', marginTop: '16px'}}>
                            <div><strong style={{color: '#818cf8'}}>ISI:</strong> <span style={{color: '#f4f4f5'}}>{resultado.isi_score}/28</span></div>
                            {resultado.stop_bang_score !== null && <div><strong style={{color: '#818cf8'}}>STOP-BANG:</strong> <span style={{color: '#f4f4f5'}}>{resultado.stop_bang_score}/8</span></div>}
                            {resultado.fenotipo && <div><strong style={{color: '#818cf8'}}>Tipo:</strong> <span style={{color: '#f4f4f5'}}>{resultado.fenotipo.nombre}</span></div>}
                        </div>
                    </div>

                    {resultado.banderas_rojas.length > 0 && (
                        <div className="card">
                            <h2>üö® Alertas Importantes</h2>
                            {resultado.banderas_rojas.map((f, i) => (
                                <div key={i} className="red-flag">
                                    <div className="red-flag-title">{f.titulo}</div>
                                    <div className="red-flag-action">‚û§ {f.accion}</div>
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="card">
                        <h2>üíä Recomendaciones Personalizadas</h2>
                        {resultado.recomendaciones.map((r, i) => (
                            <div key={i} className="recommendation">
                                <div className="recommendation-title">{i + 1}. {r.nombre} {r.primera_linea && '‚≠ê'}</div>
                                <div className="recommendation-desc">{r.descripcion}</div>
                                {r.evidencia && <span className="recommendation-evidence">Evidencia: {r.evidencia}</span>}
                                {r.contraindicaciones?.length > 0 && (
                                    <div style={{marginTop: '8px', color: '#fca5a5', fontSize: '0.85rem'}}>
                                        ‚ö†Ô∏è Precauci√≥n: {r.contraindicaciones.join(', ')}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    <div className="disclaimer">
                        <strong>‚öïÔ∏è Importante:</strong> Esta evaluaci√≥n es orientativa y NO reemplaza la consulta m√©dica.
                        Las recomendaciones deben ser validadas por un profesional de la salud antes de implementarlas.
                    </div>

                    <button className="btn btn-primary" style={{marginTop: '20px'}} onClick={onReset}>
                        ‚Üê Nueva Evaluaci√≥n
                    </button>
                </>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
